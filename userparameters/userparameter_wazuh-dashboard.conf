### WAZUH DASHBOARD — UserParameters ###
# Host: este arquivo é para o nó do Dashboard
# Teste local: zabbix_agent2 -t <chave>
# Genesis Security © 2025

# --- Serviço systemd ---
UserParameter=wazuh.dashboard.service,systemctl is-active wazuh-dashboard.service 2>/dev/null || echo inactive

# --- Porta HTTPS 443 (status 1=ok, 0=down) ---
UserParameter=wazuh.dashboard.port.443,ss -ltn '( sport = :443 )' | grep -q LISTEN && echo 1 || echo 0

# --- Healthcheck da API (painel online) ---
UserParameter=wazuh.dashboard.api.status,curl -s -o /dev/null -w "%{http_code}" -k https://127.0.0.1:443/app/wazuh
# Opcional: se o painel usa porta customizada, altere a URL

# --- SSL — dias restantes até expiração ---
UserParameter=wazuh.dashboard.ssl.daysleft,echo | openssl s_client -servername 127.0.0.1 -connect 127.0.0.1:443 2>/dev/null | openssl x509 -noout -dates | grep notAfter | cut -d= -f2 | xargs -I{} date -d {} +%s | awk -v now=$(date +%s) '{print int(($1-now)/86400)}'

# --- Processos ativos wazuh-dashboard ---
UserParameter=wazuh.dashboard.process.count,ps aux | grep '[w]azuh-dashboard' | wc -l

# --- Uso de memória do processo (MB) ---
UserParameter=wazuh.dashboard.mem.mb,ps -C node -o rss= | awk '{sum+=$1} END {print int(sum/1024)}'

# --- Uso de CPU (% aproximado) ---
UserParameter=wazuh.dashboard.cpu.percent,ps -C node -o %cpu= | awk '{sum+=$1} END {print int(sum)}'

# --- Uptime do processo (minutos) ---
UserParameter=wazuh.dashboard.uptime.min,ps -eo etimes,comm | grep wazuh-dashboard | awk '{sum+=$1} END {print int(sum/60)}'
